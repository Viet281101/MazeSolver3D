var lt=Object.defineProperty;var ht=(d,t,i)=>t in d?lt(d,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):d[t]=i;var a=(d,t,i)=>ht(d,typeof t!="symbol"?t+"":t,i);import{R as ct,P as dt,E as ut,V as E,M as Y,T as F,Q as ke,S as De,a as S,b as pt,c as mt,D as gt,F as ft,B as wt,d as yt,L as bt,e as Fe,f as Q,g as J,h as vt,G as he,C as He,i as Ct,j as Mt,W as zt,O as We}from"./three-CcvySZ3Z.js";import{G as Et}from"./datgui-DYGKXP-V.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&e(r)}).observe(document,{childList:!0,subtree:!0});function i(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function e(s){if(s.ep)return;s.ep=!0;const n=i(s);fetch(s.href,n)}})();const Re={type:"change"},ae={type:"start"},Be={type:"end"},Z=new ct,Ae=new dt,Pt=Math.cos(70*pt.DEG2RAD);class St extends ut{constructor(t,i){super(),this.object=t,this.domElement=i,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new E,this.cursor=new E,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:Y.ROTATE,MIDDLE:Y.DOLLY,RIGHT:Y.PAN},this.touches={ONE:F.ROTATE,TWO:F.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return l.phi},this.getAzimuthalAngle=function(){return l.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(o){o.addEventListener("keydown",ne),this._domElementKeyEvents=o},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",ne),this._domElementKeyEvents=null},this.saveState=function(){e.target0.copy(e.target),e.position0.copy(e.object.position),e.zoom0=e.object.zoom},this.reset=function(){e.target.copy(e.target0),e.object.position.copy(e.position0),e.object.zoom=e.zoom0,e.object.updateProjectionMatrix(),e.dispatchEvent(Re),e.update(),n=s.NONE},this.update=function(){const o=new E,h=new ke().setFromUnitVectors(t.up,new E(0,1,0)),u=h.clone().invert(),w=new E,z=new ke,k=new E,P=2*Math.PI;return function(rt=null){const Ie=e.object.position;o.copy(Ie).sub(e.target),o.applyQuaternion(h),l.setFromVector3(o),e.autoRotate&&n===s.NONE&&_(Xe(rt)),e.enableDamping?(l.theta+=c.theta*e.dampingFactor,l.phi+=c.phi*e.dampingFactor):(l.theta+=c.theta,l.phi+=c.phi);let L=e.minAzimuthAngle,T=e.maxAzimuthAngle;isFinite(L)&&isFinite(T)&&(L<-Math.PI?L+=P:L>Math.PI&&(L-=P),T<-Math.PI?T+=P:T>Math.PI&&(T-=P),L<=T?l.theta=Math.max(L,Math.min(T,l.theta)):l.theta=l.theta>(L+T)/2?Math.max(L,l.theta):Math.min(T,l.theta)),l.phi=Math.max(e.minPolarAngle,Math.min(e.maxPolarAngle,l.phi)),l.makeSafe(),e.enableDamping===!0?e.target.addScaledVector(g,e.dampingFactor):e.target.add(g),e.target.sub(e.cursor),e.target.clampLength(e.minTargetRadius,e.maxTargetRadius),e.target.add(e.cursor);let j=!1;if(e.zoomToCursor&&U||e.object.isOrthographicCamera)l.radius=se(l.radius);else{const I=l.radius;l.radius=se(l.radius*f),j=I!=l.radius}if(o.setFromSpherical(l),o.applyQuaternion(u),Ie.copy(e.target).add(o),e.object.lookAt(e.target),e.enableDamping===!0?(c.theta*=1-e.dampingFactor,c.phi*=1-e.dampingFactor,g.multiplyScalar(1-e.dampingFactor)):(c.set(0,0,0),g.set(0,0,0)),e.zoomToCursor&&U){let I=null;if(e.object.isPerspectiveCamera){const G=o.length();I=se(G*f);const $=G-I;e.object.position.addScaledVector(de,$),e.object.updateMatrixWorld(),j=!!$}else if(e.object.isOrthographicCamera){const G=new E(O.x,O.y,0);G.unproject(e.object);const $=e.object.zoom;e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom/f)),e.object.updateProjectionMatrix(),j=$!==e.object.zoom;const Oe=new E(O.x,O.y,0);Oe.unproject(e.object),e.object.position.sub(Oe).add(G),e.object.updateMatrixWorld(),I=o.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),e.zoomToCursor=!1;I!==null&&(this.screenSpacePanning?e.target.set(0,0,-1).transformDirection(e.object.matrix).multiplyScalar(I).add(e.object.position):(Z.origin.copy(e.object.position),Z.direction.set(0,0,-1).transformDirection(e.object.matrix),Math.abs(e.object.up.dot(Z.direction))<Pt?t.lookAt(e.target):(Ae.setFromNormalAndCoplanarPoint(e.object.up,e.target),Z.intersectPlane(Ae,e.target))))}else if(e.object.isOrthographicCamera){const I=e.object.zoom;e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom/f)),I!==e.object.zoom&&(e.object.updateProjectionMatrix(),j=!0)}return f=1,U=!1,j||w.distanceToSquared(e.object.position)>r||8*(1-z.dot(e.object.quaternion))>r||k.distanceToSquared(e.target)>r?(e.dispatchEvent(Re),w.copy(e.object.position),z.copy(e.object.quaternion),k.copy(e.target),!0):!1}}(),this.dispose=function(){e.domElement.removeEventListener("contextmenu",Le),e.domElement.removeEventListener("pointerdown",ze),e.domElement.removeEventListener("pointercancel",X),e.domElement.removeEventListener("wheel",Ee),e.domElement.removeEventListener("pointermove",oe),e.domElement.removeEventListener("pointerup",X),e.domElement.getRootNode().removeEventListener("keydown",Pe,{capture:!0}),e._domElementKeyEvents!==null&&(e._domElementKeyEvents.removeEventListener("keydown",ne),e._domElementKeyEvents=null)};const e=this,s={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let n=s.NONE;const r=1e-6,l=new De,c=new De;let f=1;const g=new E,p=new S,y=new S,M=new S,b=new S,C=new S,x=new S,R=new S,B=new S,H=new S,de=new E,O=new S;let U=!1;const v=[],W={};let ee=!1;function Xe(o){return o!==null?2*Math.PI/60*e.autoRotateSpeed*o:2*Math.PI/60/60*e.autoRotateSpeed}function q(o){const h=Math.abs(o*.01);return Math.pow(.95,e.zoomSpeed*h)}function _(o){c.theta-=o}function K(o){c.phi-=o}const ue=function(){const o=new E;return function(u,w){o.setFromMatrixColumn(w,0),o.multiplyScalar(-u),g.add(o)}}(),pe=function(){const o=new E;return function(u,w){e.screenSpacePanning===!0?o.setFromMatrixColumn(w,1):(o.setFromMatrixColumn(w,0),o.crossVectors(e.object.up,o)),o.multiplyScalar(u),g.add(o)}}(),A=function(){const o=new E;return function(u,w){const z=e.domElement;if(e.object.isPerspectiveCamera){const k=e.object.position;o.copy(k).sub(e.target);let P=o.length();P*=Math.tan(e.object.fov/2*Math.PI/180),ue(2*u*P/z.clientHeight,e.object.matrix),pe(2*w*P/z.clientHeight,e.object.matrix)}else e.object.isOrthographicCamera?(ue(u*(e.object.right-e.object.left)/e.object.zoom/z.clientWidth,e.object.matrix),pe(w*(e.object.top-e.object.bottom)/e.object.zoom/z.clientHeight,e.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),e.enablePan=!1)}}();function te(o){e.object.isPerspectiveCamera||e.object.isOrthographicCamera?f/=o:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function me(o){e.object.isPerspectiveCamera||e.object.isOrthographicCamera?f*=o:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function ie(o,h){if(!e.zoomToCursor)return;U=!0;const u=e.domElement.getBoundingClientRect(),w=o-u.left,z=h-u.top,k=u.width,P=u.height;O.x=w/k*2-1,O.y=-(z/P)*2+1,de.set(O.x,O.y,1).unproject(e.object).sub(e.object.position).normalize()}function se(o){return Math.max(e.minDistance,Math.min(e.maxDistance,o))}function ge(o){p.set(o.clientX,o.clientY)}function je(o){ie(o.clientX,o.clientX),R.set(o.clientX,o.clientY)}function fe(o){b.set(o.clientX,o.clientY)}function Ge(o){y.set(o.clientX,o.clientY),M.subVectors(y,p).multiplyScalar(e.rotateSpeed);const h=e.domElement;_(2*Math.PI*M.x/h.clientHeight),K(2*Math.PI*M.y/h.clientHeight),p.copy(y),e.update()}function Ve(o){B.set(o.clientX,o.clientY),H.subVectors(B,R),H.y>0?te(q(H.y)):H.y<0&&me(q(H.y)),R.copy(B),e.update()}function Ue(o){C.set(o.clientX,o.clientY),x.subVectors(C,b).multiplyScalar(e.panSpeed),A(x.x,x.y),b.copy(C),e.update()}function qe(o){ie(o.clientX,o.clientY),o.deltaY<0?me(q(o.deltaY)):o.deltaY>0&&te(q(o.deltaY)),e.update()}function Ke(o){let h=!1;switch(o.code){case e.keys.UP:o.ctrlKey||o.metaKey||o.shiftKey?K(2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):A(0,e.keyPanSpeed),h=!0;break;case e.keys.BOTTOM:o.ctrlKey||o.metaKey||o.shiftKey?K(-2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):A(0,-e.keyPanSpeed),h=!0;break;case e.keys.LEFT:o.ctrlKey||o.metaKey||o.shiftKey?_(2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):A(e.keyPanSpeed,0),h=!0;break;case e.keys.RIGHT:o.ctrlKey||o.metaKey||o.shiftKey?_(-2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):A(-e.keyPanSpeed,0),h=!0;break}h&&(o.preventDefault(),e.update())}function we(o){if(v.length===1)p.set(o.pageX,o.pageY);else{const h=N(o),u=.5*(o.pageX+h.x),w=.5*(o.pageY+h.y);p.set(u,w)}}function ye(o){if(v.length===1)b.set(o.pageX,o.pageY);else{const h=N(o),u=.5*(o.pageX+h.x),w=.5*(o.pageY+h.y);b.set(u,w)}}function be(o){const h=N(o),u=o.pageX-h.x,w=o.pageY-h.y,z=Math.sqrt(u*u+w*w);R.set(0,z)}function $e(o){e.enableZoom&&be(o),e.enablePan&&ye(o)}function Ze(o){e.enableZoom&&be(o),e.enableRotate&&we(o)}function ve(o){if(v.length==1)y.set(o.pageX,o.pageY);else{const u=N(o),w=.5*(o.pageX+u.x),z=.5*(o.pageY+u.y);y.set(w,z)}M.subVectors(y,p).multiplyScalar(e.rotateSpeed);const h=e.domElement;_(2*Math.PI*M.x/h.clientHeight),K(2*Math.PI*M.y/h.clientHeight),p.copy(y)}function Ce(o){if(v.length===1)C.set(o.pageX,o.pageY);else{const h=N(o),u=.5*(o.pageX+h.x),w=.5*(o.pageY+h.y);C.set(u,w)}x.subVectors(C,b).multiplyScalar(e.panSpeed),A(x.x,x.y),b.copy(C)}function Me(o){const h=N(o),u=o.pageX-h.x,w=o.pageY-h.y,z=Math.sqrt(u*u+w*w);B.set(0,z),H.set(0,Math.pow(B.y/R.y,e.zoomSpeed)),te(H.y),R.copy(B);const k=(o.pageX+h.x)*.5,P=(o.pageY+h.y)*.5;ie(k,P)}function Qe(o){e.enableZoom&&Me(o),e.enablePan&&Ce(o)}function Je(o){e.enableZoom&&Me(o),e.enableRotate&&ve(o)}function ze(o){e.enabled!==!1&&(v.length===0&&(e.domElement.setPointerCapture(o.pointerId),e.domElement.addEventListener("pointermove",oe),e.domElement.addEventListener("pointerup",X)),!at(o)&&(ot(o),o.pointerType==="touch"?xe(o):et(o)))}function oe(o){e.enabled!==!1&&(o.pointerType==="touch"?st(o):tt(o))}function X(o){switch(nt(o),v.length){case 0:e.domElement.releasePointerCapture(o.pointerId),e.domElement.removeEventListener("pointermove",oe),e.domElement.removeEventListener("pointerup",X),e.dispatchEvent(Be),n=s.NONE;break;case 1:const h=v[0],u=W[h];xe({pointerId:h,pageX:u.x,pageY:u.y});break}}function et(o){let h;switch(o.button){case 0:h=e.mouseButtons.LEFT;break;case 1:h=e.mouseButtons.MIDDLE;break;case 2:h=e.mouseButtons.RIGHT;break;default:h=-1}switch(h){case Y.DOLLY:if(e.enableZoom===!1)return;je(o),n=s.DOLLY;break;case Y.ROTATE:if(o.ctrlKey||o.metaKey||o.shiftKey){if(e.enablePan===!1)return;fe(o),n=s.PAN}else{if(e.enableRotate===!1)return;ge(o),n=s.ROTATE}break;case Y.PAN:if(o.ctrlKey||o.metaKey||o.shiftKey){if(e.enableRotate===!1)return;ge(o),n=s.ROTATE}else{if(e.enablePan===!1)return;fe(o),n=s.PAN}break;default:n=s.NONE}n!==s.NONE&&e.dispatchEvent(ae)}function tt(o){switch(n){case s.ROTATE:if(e.enableRotate===!1)return;Ge(o);break;case s.DOLLY:if(e.enableZoom===!1)return;Ve(o);break;case s.PAN:if(e.enablePan===!1)return;Ue(o);break}}function Ee(o){e.enabled===!1||e.enableZoom===!1||n!==s.NONE||(o.preventDefault(),e.dispatchEvent(ae),qe(it(o)),e.dispatchEvent(Be))}function it(o){const h=o.deltaMode,u={clientX:o.clientX,clientY:o.clientY,deltaY:o.deltaY};switch(h){case 1:u.deltaY*=16;break;case 2:u.deltaY*=100;break}return o.ctrlKey&&!ee&&(u.deltaY*=10),u}function Pe(o){o.key==="Control"&&(ee=!0,e.domElement.getRootNode().addEventListener("keyup",Se,{passive:!0,capture:!0}))}function Se(o){o.key==="Control"&&(ee=!1,e.domElement.getRootNode().removeEventListener("keyup",Se,{passive:!0,capture:!0}))}function ne(o){e.enabled===!1||e.enablePan===!1||Ke(o)}function xe(o){switch(Te(o),v.length){case 1:switch(e.touches.ONE){case F.ROTATE:if(e.enableRotate===!1)return;we(o),n=s.TOUCH_ROTATE;break;case F.PAN:if(e.enablePan===!1)return;ye(o),n=s.TOUCH_PAN;break;default:n=s.NONE}break;case 2:switch(e.touches.TWO){case F.DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;$e(o),n=s.TOUCH_DOLLY_PAN;break;case F.DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;Ze(o),n=s.TOUCH_DOLLY_ROTATE;break;default:n=s.NONE}break;default:n=s.NONE}n!==s.NONE&&e.dispatchEvent(ae)}function st(o){switch(Te(o),n){case s.TOUCH_ROTATE:if(e.enableRotate===!1)return;ve(o),e.update();break;case s.TOUCH_PAN:if(e.enablePan===!1)return;Ce(o),e.update();break;case s.TOUCH_DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;Qe(o),e.update();break;case s.TOUCH_DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;Je(o),e.update();break;default:n=s.NONE}}function Le(o){e.enabled!==!1&&o.preventDefault()}function ot(o){v.push(o.pointerId)}function nt(o){delete W[o.pointerId];for(let h=0;h<v.length;h++)if(v[h]==o.pointerId){v.splice(h,1);return}}function at(o){for(let h=0;h<v.length;h++)if(v[h]==o.pointerId)return!0;return!1}function Te(o){let h=W[o.pointerId];h===void 0&&(h=new S,W[o.pointerId]=h),h.set(o.pageX,o.pageY)}function N(o){const h=o.pointerId===v[0]?v[1]:v[0];return W[h]}e.domElement.addEventListener("contextmenu",Le),e.domElement.addEventListener("pointerdown",ze),e.domElement.addEventListener("pointercancel",X),e.domElement.addEventListener("wheel",Ee,{passive:!1}),e.domElement.getRootNode().addEventListener("keydown",Pe,{passive:!0,capture:!0}),this.update()}}class xt{constructor(){a(this,"materials",new Map);a(this,"geometries",new Map);a(this,"edgeGeometries",new Map);a(this,"edgeMaterial",null)}getMaterial(t,i,e,s){const n=`${t}-${i}`;if(!this.materials.has(n)){const l=new mt({color:e.clone(),transparent:s<1,opacity:s,side:i==="floor"?gt:ft});this.materials.set(n,l)}const r=this.materials.get(n);return r.color.copy(e),r.opacity=s,r.transparent=s<1,r}getBoxGeometry(t,i,e){const s=`box-${t}-${i}-${e}`;return this.geometries.has(s)||this.geometries.set(s,new wt(t,i,e)),this.geometries.get(s)}getPlaneGeometry(t,i){const e=`plane-${t}-${i}`;return this.geometries.has(e)||this.geometries.set(e,new yt(t,i)),this.geometries.get(e)}getEdgeMaterial(){return this.edgeMaterial||(this.edgeMaterial=new bt({color:0,transparent:!0,opacity:.9,depthTest:!0,depthWrite:!1,polygonOffset:!0,polygonOffsetFactor:-1,polygonOffsetUnits:-1})),this.edgeMaterial}getEdgesGeometry(t){const i=`edges-${t.uuid}`;return this.edgeGeometries.has(i)||this.edgeGeometries.set(i,new Fe(t)),this.edgeGeometries.get(i)}updateMaterialColor(t,i){this.materials.forEach((e,s)=>{(s.endsWith(`-${t}`)||s.includes(`-${t}-`))&&e.color.copy(i)})}updateMaterialOpacity(t,i){this.materials.forEach((e,s)=>{if(s.endsWith(`-${t}`)||s.includes(`-${t}-`)){const n=e,r=n.transparent;n.opacity=i,n.transparent=i<1,n.transparent!==r&&(n.needsUpdate=!0)}})}dispose(){this.materials.forEach(t=>{t.dispose()}),this.materials.clear(),this.geometries.forEach(t=>{t.dispose()}),this.geometries.clear(),this.edgeGeometries.forEach(t=>{t.dispose()}),this.edgeGeometries.clear(),this.edgeMaterial&&(this.edgeMaterial.dispose(),this.edgeMaterial=null)}clearMaterialCache(){this.materials.forEach(t=>t.dispose()),this.materials.clear()}}class re{static disposeObject(t){t instanceof Q?this.disposeMesh(t):(t instanceof J||t instanceof vt)&&this.disposeLine(t),[...t.children].forEach(e=>{this.disposeObject(e),t.remove(e)})}static disposeMesh(t){t.geometry&&!t.userData.sharedGeometry&&t.geometry.dispose(),t.material&&!t.userData.sharedMaterial&&this.disposeMaterial(t.material)}static disposeLine(t){t.geometry&&!t.userData.sharedGeometry&&t.geometry.dispose(),t.material&&!t.userData.sharedMaterial&&this.disposeMaterial(t.material)}static disposeMaterial(t){Array.isArray(t)?t.forEach(i=>i.dispose()):t.dispose()}static disposeScene(t){[...t.children].forEach(e=>{this.disposeObject(e),t.remove(e)})}static disposeGroup(t){[...t.children].forEach(e=>{this.disposeObject(e),t.remove(e)})}static disposeEdgesFromGroup(t){const i=[];return t.children.forEach(e=>{e instanceof J&&(i.push(e),this.disposeLine(e))}),i.forEach(e=>t.remove(e)),i}}class Lt{constructor(t,i,e,s,n,r){this.resourceManager=t,this.wallColor=i,this.floorColor=e,this.wallOpacity=s,this.floorOpacity=n,this.showEdges=r}createWall(t){const{x:i,y:e,z:s,width:n,height:r,depth:l}=t,c=this.resourceManager.getBoxGeometry(n,r,l),f=this.resourceManager.getMaterial("wall","wall",this.wallColor,this.wallOpacity),g=new Q(c,f);g.position.set(i,e,s),g.userData.sharedGeometry=!0,g.userData.sharedMaterial=!0;const p=new he;return p.add(g),this.showEdges&&this.addEdgesToGroup(p,c,i,e,s),p}createFloor(t){const{x:i,y:e,z:s,width:n,height:r,rotationX:l=-Math.PI/2}=t,c=this.resourceManager.getPlaneGeometry(n,r),f=this.resourceManager.getMaterial("floor","floor",this.floorColor,this.floorOpacity),g=new Q(c,f);g.rotation.x=l,g.position.set(i,e,s),g.userData.sharedGeometry=!0,g.userData.sharedMaterial=!0;const p=new he;return p.add(g),this.showEdges&&this.addEdgesToGroup(p,c,i,e,s,l),p}createSmallFloor(t,i,e,s){return this.createFloor({x:t,y:i,z:e,width:s,height:s,rotationX:-Math.PI/2})}addEdgesToGroup(t,i,e,s,n,r=0){const l=this.resourceManager.getEdgesGeometry(i),c=this.resourceManager.getEdgeMaterial(),f=new J(l,c);f.position.set(e,s,n),f.rotation.x=r,f.renderOrder=1,f.userData.sharedGeometry=!0,f.userData.sharedMaterial=!0,t.add(f)}updateSettings(t){t.wallColor&&(this.wallColor=t.wallColor),t.floorColor&&(this.floorColor=t.floorColor),t.wallOpacity!==void 0&&(this.wallOpacity=t.wallOpacity),t.floorOpacity!==void 0&&(this.floorOpacity=t.floorOpacity),t.showEdges!==void 0&&(this.showEdges=t.showEdges)}}class _e{constructor(t,i,e={}){a(this,"canvas");a(this,"scene");a(this,"camera");a(this,"renderer");a(this,"controls");a(this,"maze");a(this,"mazeLayers",[]);a(this,"wallHeight");a(this,"wallThickness");a(this,"cellSize");a(this,"wallColor");a(this,"floorColor");a(this,"wallOpacity");a(this,"floorOpacity");a(this,"showEdges");a(this,"resourceManager");a(this,"meshFactory");a(this,"animationId",null);a(this,"needsRender",!0);a(this,"isRendering",!1);a(this,"isDisposed",!1);a(this,"renderListeners",new Set);this.canvas=t,this.maze=i,this.wallHeight=e.wallHeight??1,this.wallThickness=e.wallThickness??.1,this.cellSize=e.cellSize??1,this.wallColor=new He(8421504),this.floorColor=new He(12632256),this.wallOpacity=1,this.floorOpacity=1,this.showEdges=!0,this.scene=new Ct,this.camera=new Mt(75,window.innerWidth/window.innerHeight,.1,1e3),this.renderer=new zt({canvas:this.canvas,antialias:!0,powerPreference:"high-performance"}),this.renderer.domElement.style.touchAction="none",this.controls=new St(this.camera,this.renderer.domElement),this.resourceManager=new xt,this.meshFactory=new Lt(this.resourceManager,this.wallColor,this.floorColor,this.wallOpacity,this.floorOpacity,this.showEdges),this.init()}init(){const{width:t,height:i,pixelRatio:e}=this.getRendererSize();this.renderer.setPixelRatio(e),this.renderer.setSize(t,i),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.addEventListener("change",()=>this.requestRender()),this.createMaze(),this.requestRender()}updateMazeData(t){this.isDisposed||(this.maze=t,this.createMaze(),this.requestRender())}positionCamera(t,i,e){this.camera.position.set(t,10,e),this.controls.target.set(t,0,i),this.controls.update(),this.controls.saveState()}requestRender(){this.isDisposed||(this.needsRender=!0,!this.isRendering&&(this.isRendering=!0,this.animationId=requestAnimationFrame(()=>{if(this.isDisposed){this.isRendering=!1;return}if(!this.needsRender){this.isRendering=!1;return}this.needsRender=!1;const t=this.controls.update();this.renderer.render(this.scene,this.camera),this.renderListeners.forEach(i=>i()),this.isRendering=!1,(t||this.needsRender)&&this.requestRender()})))}stopAnimation(){this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null)}resize(){if(this.isDisposed)return;this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix();const{width:t,height:i,pixelRatio:e}=this.getRendererSize();this.renderer.setPixelRatio(e),this.renderer.setSize(t,i),this.requestRender()}deleteMaze(){this.mazeLayers.forEach(t=>{re.disposeObject(t),this.scene.remove(t)}),this.mazeLayers=[]}destroy(){this.isDisposed||(this.isDisposed=!0,this.stopAnimation(),this.deleteMaze(),this.controls.dispose(),this.resourceManager.dispose(),re.disposeScene(this.scene),this.renderer.dispose())}getRenderer(){return this.renderer}getMazeData(){return this.maze.map(t=>t.map(i=>i.slice()))}updateWallColor(t){this.wallColor.set(t),this.resourceManager.updateMaterialColor("wall",this.wallColor),this.meshFactory.updateSettings({wallColor:this.wallColor}),this.requestRender()}updateFloorColor(t){this.floorColor.set(t),this.resourceManager.updateMaterialColor("floor",this.floorColor),this.meshFactory.updateSettings({floorColor:this.floorColor}),this.requestRender()}updateWallOpacity(t){this.wallOpacity=t,this.resourceManager.updateMaterialOpacity("wall",t),this.meshFactory.updateSettings({wallOpacity:t}),this.requestRender()}updateFloorOpacity(t){this.floorOpacity=t,this.resourceManager.updateMaterialOpacity("floor",t),this.meshFactory.updateSettings({floorOpacity:t}),this.requestRender()}toggleEdges(t){this.showEdges!==t&&(this.showEdges=t,this.meshFactory.updateSettings({showEdges:t}),this.rebuildEdges(),this.requestRender())}addRenderListener(t){this.renderListeners.add(t)}removeRenderListener(t){this.renderListeners.delete(t)}rebuildEdges(){this.mazeLayers.forEach(t=>{t.children.forEach(i=>{i instanceof he&&(re.disposeEdgesFromGroup(i),this.showEdges&&i.children.forEach(e=>{if(e instanceof Q){const s=new Fe(e.geometry),n=this.resourceManager.getEdgeMaterial(),r=new J(s,n);r.position.copy(e.position),r.rotation.copy(e.rotation),i.add(r)}}))})}),this.requestRender()}getRendererSize(){const t=Math.min(window.devicePixelRatio,1.5),i=this.renderer.capabilities.maxTextureSize,e=Math.floor(i/t),s=Math.min(window.innerWidth,e),n=Math.min(window.innerHeight,e);return{width:s,height:n,pixelRatio:t}}}class le extends _e{constructor(t,i,e){super(t,i,e)}createMaze(){this.deleteMaze();const t=new We,i=this.maze[0];this.createWalls(i,t),this.createMainFloor(i,t),this.mazeLayers.push(t),this.scene.add(t),this.positionCameraForMaze(i)}createWalls(t,i){t.forEach((e,s)=>{e.forEach((n,r)=>{if(n===1){if(r<e.length-1&&e[r+1]===1){const l=this.meshFactory.createWall({x:r*this.cellSize+this.cellSize/2,y:this.wallHeight/2,z:-s*this.cellSize,width:this.cellSize,height:this.wallHeight,depth:this.wallThickness});i.add(l)}if(s<t.length-1&&t[s+1][r]===1){const l=this.meshFactory.createWall({x:r*this.cellSize,y:this.wallHeight/2,z:-(s*this.cellSize+this.cellSize/2),width:this.wallThickness,height:this.wallHeight,depth:this.cellSize});i.add(l)}}})})}createMainFloor(t,i){const e=t[0].length*this.cellSize,s=t.length*this.cellSize,n=this.meshFactory.createFloor({x:e/2-this.cellSize/2,y:-this.wallThickness/2,z:-(s/2)+this.cellSize/2,width:e,height:s});i.add(n)}positionCameraForMaze(t){const i=t[0].length*this.cellSize/2-this.cellSize/2,e=-(t.length*this.cellSize)/2+this.cellSize/2,s=t.length*this.cellSize;this.positionCamera(i,e,s)}}class Ne extends _e{constructor(t,i,e){super(t,i,e)}createMaze(){this.deleteMaze(),this.maze.forEach((t,i)=>{const e=new We,s=i*this.wallHeight;this.createWallsForLayer(t,s,e),i>0?this.createLayerFloors(t,s,e):this.createMainFloor(t,e),this.mazeLayers.push(e),this.scene.add(e)}),this.positionCameraForMultiLayer()}createWallsForLayer(t,i,e){t.forEach((s,n)=>{s.forEach((r,l)=>{if(r===1){if(l<s.length-1&&s[l+1]===1){const c=this.meshFactory.createWall({x:l*this.cellSize+this.cellSize/2,y:i+this.wallHeight/2,z:-n*this.cellSize,width:this.cellSize,height:this.wallHeight,depth:this.wallThickness});e.add(c)}if(n<t.length-1&&t[n+1][l]===1){const c=this.meshFactory.createWall({x:l*this.cellSize,y:i+this.wallHeight/2,z:-(n*this.cellSize+this.cellSize/2),width:this.wallThickness,height:this.wallHeight,depth:this.cellSize});e.add(c)}}})})}createLayerFloors(t,i,e){t.forEach((s,n)=>{s.forEach((r,l)=>{if(r!==2){const c=this.meshFactory.createSmallFloor(l*this.cellSize,i,-n*this.cellSize,this.cellSize);e.add(c)}})})}createMainFloor(t,i){const e=t[0].length*this.cellSize,s=t.length*this.cellSize,n=this.meshFactory.createFloor({x:e/2-this.cellSize/2,y:-this.wallThickness/2,z:-(s/2)+this.cellSize/2,width:e,height:s});i.add(n)}positionCameraForMultiLayer(){const t=this.maze[0],i=t[0].length*this.cellSize/2-this.cellSize/2,e=-(t.length*this.cellSize)/2+this.cellSize/2,s=this.maze.length*this.cellSize;this.positionCamera(i,e,s)}}function Tt(d){const i=d.createPopupContainer("solvePopup","Solving Maze").querySelector("canvas"),e=i.getContext("2d");e&&(e.fillStyle="#a0a0a0",e.fillRect(0,0,i.width,i.height))}function It(d){const i=d.createPopupContainer("settingsPopup","Settings").querySelector("canvas"),e=i.getContext("2d");e&&(e.fillStyle="#a0a0a0",e.fillRect(0,0,i.width,i.height))}function Ot(d){const i=d.createPopupContainer("tutorialPopup","Tutorial").querySelector("canvas"),e=i.getContext("2d");e&&(e.fillStyle="#a0a0a0",e.fillRect(0,0,i.width,i.height))}class kt{constructor(t){a(this,"toolbar");a(this,"popupContainer");a(this,"canvas");a(this,"ctx");a(this,"state");a(this,"rowsInput");a(this,"colsInput");a(this,"toolButtons");a(this,"createBtn");a(this,"clearBtn");a(this,"applyBtn");a(this,"loadBtn");a(this,"onMouseDown");a(this,"onMouseMove");a(this,"onMouseUp");a(this,"onMouseLeave");a(this,"onWheel");a(this,"onContextMenu");this.toolbar=t,this.popupContainer=this.toolbar.createPopupContainer("mazePopup","Custom Maze"),this.popupContainer.classList.add("maze-popup");const i=this.popupContainer.querySelector("canvas");if(!i)throw new Error("Maze popup canvas not found");const e=i.getContext("2d",{alpha:!1,desynchronized:!0});if(!e)throw new Error("Failed to get 2D context for maze popup");this.canvas=i,this.ctx=e,this.canvas.classList.add("maze-popup__canvas"),this.canvas.width=330,this.canvas.height=330;const s=this.buildControls();this.popupContainer.insertBefore(s.controls,this.canvas),this.popupContainer.insertBefore(s.applySection,this.canvas.nextSibling),this.rowsInput=s.rowsInput,this.colsInput=s.colsInput,this.toolButtons=s.toolButtons,this.createBtn=s.createBtn,this.clearBtn=s.clearBtn,this.applyBtn=s.applyBtn,this.loadBtn=s.loadBtn,this.state={rows:this.rowsInput.valueAsNumber,cols:this.colsInput.valueAsNumber,grid:[],start:null,end:null,tool:"pen",cellSize:22,scale:1,minScale:.35,maxScale:6,offsetX:0,offsetY:0,isPanning:!1,isDrawing:!1,lastX:0,lastY:0},this.onMouseDown=n=>this.handleMouseDown(n),this.onMouseMove=n=>this.handleMouseMove(n),this.onMouseUp=()=>this.handleMouseUp(),this.onMouseLeave=()=>this.handleMouseLeave(),this.onWheel=n=>this.handleWheel(n),this.onContextMenu=n=>n.preventDefault(),this.bindEvents(),this.setTool("pen"),this.rebuild(this.state.rows,this.state.cols)}buildControls(){const t=document.createElement("div");t.className="maze-popup__controls";const i=document.createElement("div");i.className="maze-popup__section-title",i.textContent="Single Layer Maze custom",t.appendChild(i);const e=document.createElement("div");e.className="maze-popup__section";const s=Ye("Rows",5,80,12),n=Ye("Cols",5,80,12),r=D("Create","maze-popup__btn"),l=D("Load Current Maze","maze-popup__btn");e.appendChild(s.wrapper),e.appendChild(n.wrapper),e.appendChild(r),e.appendChild(l);const c=document.createElement("div");c.className="maze-popup__section";const f=D("Pen","maze-popup__tool"),g=D("Eraser","maze-popup__tool"),p=D("Start","maze-popup__tool"),y=D("End","maze-popup__tool");c.appendChild(f),c.appendChild(g),c.appendChild(p),c.appendChild(y);const M=document.createElement("div");M.className="maze-popup__section";const b=D("Clear","maze-popup__btn");M.appendChild(b);const C=document.createElement("div");C.className="maze-popup__section maze-popup__section--apply";const x=D("Apply","maze-popup__btn maze-popup__btn--primary");return C.appendChild(x),t.appendChild(e),t.appendChild(c),t.appendChild(M),{controls:t,applySection:C,rowsInput:s.input,colsInput:n.input,createBtn:r,loadBtn:l,clearBtn:b,applyBtn:x,toolButtons:{pen:f,eraser:g,start:p,end:y}}}bindEvents(){this.createBtn.addEventListener("click",()=>this.handleCreate()),this.loadBtn.addEventListener("click",()=>this.handleLoadCurrent()),this.clearBtn.addEventListener("click",()=>this.handleClear()),this.applyBtn.addEventListener("click",()=>this.handleApply()),this.toolButtons.pen.addEventListener("click",()=>this.setTool("pen")),this.toolButtons.eraser.addEventListener("click",()=>this.setTool("eraser")),this.toolButtons.start.addEventListener("click",()=>this.setTool("start")),this.toolButtons.end.addEventListener("click",()=>this.setTool("end")),this.canvas.addEventListener("contextmenu",this.onContextMenu),this.canvas.addEventListener("mousedown",this.onMouseDown),this.canvas.addEventListener("mousemove",this.onMouseMove),this.canvas.addEventListener("mouseup",this.onMouseUp),this.canvas.addEventListener("mouseleave",this.onMouseLeave),this.canvas.addEventListener("wheel",this.onWheel,{passive:!1})}setTool(t){this.state.tool=t,Object.entries(this.toolButtons).forEach(([i,e])=>{i===t?e.classList.add("is-active"):e.classList.remove("is-active")})}initGrid(t,i){const e=[];for(let s=0;s<t;s+=1){const n=[];for(let r=0;r<i;r+=1){const l=s===0||r===0||s===t-1||r===i-1;n.push(l?1:0)}e.push(n)}return e}resetView(){const t=this.state.cols*this.state.cellSize,i=this.state.rows*this.state.cellSize,e=1;this.state.scale=e,this.state.offsetX=(this.canvas.width-t*e)/2,this.state.offsetY=(this.canvas.height-i*e)/2}clamp(t,i,e){return Math.max(i,Math.min(e,t))}draw(){this.ctx.setTransform(1,0,0,1,0,0),this.ctx.fillStyle="#33566b",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.ctx.translate(this.state.offsetX,this.state.offsetY),this.ctx.scale(this.state.scale,this.state.scale);const t=this.state.cols*this.state.cellSize,i=this.state.rows*this.state.cellSize;this.ctx.fillStyle="#e6e6e6",this.ctx.fillRect(0,0,t,i),this.ctx.fillStyle="#333";for(let e=0;e<this.state.rows;e+=1)for(let s=0;s<this.state.cols;s+=1)this.state.grid[e][s]===1&&this.ctx.fillRect(s*this.state.cellSize,e*this.state.cellSize,this.state.cellSize,this.state.cellSize);this.state.start&&(this.ctx.fillStyle="rgba(0, 200, 120, 0.85)",this.ctx.fillRect(this.state.start.col*this.state.cellSize,this.state.start.row*this.state.cellSize,this.state.cellSize,this.state.cellSize)),this.state.end&&(this.ctx.fillStyle="rgba(220, 60, 60, 0.85)",this.ctx.fillRect(this.state.end.col*this.state.cellSize,this.state.end.row*this.state.cellSize,this.state.cellSize,this.state.cellSize)),this.ctx.strokeStyle="rgba(0,0,0,0.15)",this.ctx.lineWidth=1/this.state.scale;for(let e=0;e<=this.state.cols;e+=1){const s=e*this.state.cellSize;this.ctx.beginPath(),this.ctx.moveTo(s,0),this.ctx.lineTo(s,i),this.ctx.stroke()}for(let e=0;e<=this.state.rows;e+=1){const s=e*this.state.cellSize;this.ctx.beginPath(),this.ctx.moveTo(0,s),this.ctx.lineTo(t,s),this.ctx.stroke()}this.ctx.restore()}getCellFromEvent(t){const i=this.canvas.getBoundingClientRect(),e=(t.clientX-i.left-this.state.offsetX)/this.state.scale,s=(t.clientY-i.top-this.state.offsetY)/this.state.scale,n=Math.floor(e/this.state.cellSize),r=Math.floor(s/this.state.cellSize);return r<0||n<0||r>=this.state.rows||n>=this.state.cols?null:{row:r,col:n}}applyToolAt(t){if(!t)return;const{row:i,col:e}=t;this.state.tool==="pen"?this.state.grid[i][e]=1:this.state.tool==="eraser"?(this.state.grid[i][e]=0,this.state.start&&this.state.start.row===i&&this.state.start.col===e&&(this.state.start=null),this.state.end&&this.state.end.row===i&&this.state.end.col===e&&(this.state.end=null)):this.state.tool==="start"?(this.state.grid[i][e]=0,this.state.start={row:i,col:e}):this.state.tool==="end"&&(this.state.grid[i][e]=0,this.state.end={row:i,col:e}),this.draw()}rebuild(t,i){this.state.rows=t,this.state.cols=i,this.state.grid=this.initGrid(t,i),this.state.start=null,this.state.end=null,this.resetView(),this.draw()}handleCreate(){const t=this.clamp(this.rowsInput.valueAsNumber||0,5,80),i=this.clamp(this.colsInput.valueAsNumber||0,5,80);this.rowsInput.valueAsNumber=t,this.colsInput.valueAsNumber=i,this.rebuild(t,i)}handleClear(){this.state.grid=this.initGrid(this.state.rows,this.state.cols),this.state.start=null,this.state.end=null,this.draw()}handleLoadCurrent(){const t=window.mazeApp;if(!t||typeof t.getMazeData!="function"){console.warn("mazeApp.getMazeData not available");return}const i=t.getMazeData(),e=t&&typeof t.getMazeMarkers=="function"?t.getMazeMarkers():null;if(!Array.isArray(i)||i.length===0||!Array.isArray(i[0])){console.warn("No maze data available to load");return}if(i.length!==1){console.warn("Current maze is not single-layer. Load is blocked."),window.alert("Only single-layer mazes can be loaded into the editor.");return}const s=i[0];if(!s||s.length===0||!Array.isArray(s[0])){console.warn("Maze layer is empty");return}const n=s.length,r=s[0].length,l=this.clamp(n,5,80),c=this.clamp(r,5,80);(n!==l||r!==c)&&console.warn("Maze size exceeds popup limits, data will be clamped");const f=s.slice().reverse(),g=[];for(let p=0;p<l;p+=1){const y=[],M=f[p]??[];for(let b=0;b<c;b+=1){const C=M[b]??1;y.push(C===0?0:1)}g.push(y)}if(this.state.rows=l,this.state.cols=c,this.state.grid=g,this.state.start=null,this.state.end=null,e){if(e.start){const p=l-1-e.start.row;p>=0&&p<l&&e.start.col>=0&&e.start.col<c&&(this.state.start={row:p,col:e.start.col})}if(e.end){const p=l-1-e.end.row;p>=0&&p<l&&e.end.col>=0&&e.end.col<c&&(this.state.end={row:p,col:e.end.col})}}this.rowsInput.valueAsNumber=l,this.colsInput.valueAsNumber=c,this.resetView(),this.draw()}handleApply(){const t=[this.state.grid.map(n=>n.slice()).reverse()],i=window.mazeApp;if(!i||typeof i.updateMaze!="function"){console.warn("mazeApp.updateMaze not available");return}const e=this.state.start?{row:this.state.rows-1-this.state.start.row,col:this.state.start.col}:null,s=this.state.end?{row:this.state.rows-1-this.state.end.row,col:this.state.end.col}:null;i.updateMaze(t,!1,{start:e,end:s})}handleMouseDown(t){if(t.button===2){this.state.isPanning=!0,this.state.lastX=t.clientX,this.state.lastY=t.clientY;return}t.button===0&&(this.state.isDrawing=!0,this.applyToolAt(this.getCellFromEvent(t)))}handleMouseMove(t){if(this.state.isPanning){const i=t.clientX-this.state.lastX,e=t.clientY-this.state.lastY;this.state.lastX=t.clientX,this.state.lastY=t.clientY,this.state.offsetX+=i,this.state.offsetY+=e,this.draw();return}this.state.isDrawing&&this.applyToolAt(this.getCellFromEvent(t))}handleMouseUp(){this.state.isPanning=!1,this.state.isDrawing=!1}handleMouseLeave(){this.state.isPanning=!1,this.state.isDrawing=!1}handleWheel(t){t.preventDefault();const i=this.canvas.getBoundingClientRect(),e=t.clientX-i.left,s=t.clientY-i.top,n=Math.exp(-t.deltaY*.0015),r=this.clamp(this.state.scale*n,this.state.minScale,this.state.maxScale),l=(e-this.state.offsetX)/this.state.scale,c=(s-this.state.offsetY)/this.state.scale;this.state.scale=r,this.state.offsetX=e-l*this.state.scale,this.state.offsetY=s-c*this.state.scale,this.draw()}}function Dt(d){try{new kt(d)}catch(t){console.error("Failed to initialize maze popup:",t)}}function Ye(d,t,i,e){const s=document.createElement("label");s.className="maze-popup__input";const n=document.createElement("span");n.textContent=d;const r=document.createElement("input");return r.type="number",r.min=String(t),r.max=String(i),r.value=String(e),s.appendChild(n),s.appendChild(r),{wrapper:s,input:r}}function D(d,t){const i=document.createElement("button");return i.type="button",i.textContent=d,i.className=t,i}function Ht(d){const i=d.createPopupContainer("generatePopup","Generate Maze").querySelector("canvas"),e=i.getContext("2d");e&&(e.fillStyle="#a0a0a0",e.fillRect(0,0,i.width,i.height))}class Rt{constructor(){a(this,"canvas");a(this,"ctx");a(this,"isMobile");a(this,"buttons");a(this,"popupOpen");a(this,"currentPopup");a(this,"currentCloseIcon");a(this,"currentHideIcon");a(this,"tooltip",null);a(this,"hoveredButton",null);a(this,"mouseMoveHandler");a(this,"mouseLeaveHandler");a(this,"mouseDownHandler");a(this,"touchStartHandler");a(this,"documentClickHandler");a(this,"imageCache",new Map);a(this,"imagesLoaded",!1);this.isMobile=this.checkIfMobile(),this.setupCanvas(),this.buttons=this.createButtons(),this.popupOpen=!1,this.currentPopup=null,this.currentCloseIcon=null,this.currentHideIcon=null,this.preloadImages().then(()=>{this.imagesLoaded=!0,this.drawToolbar()}),this.addEventListeners()}checkIfMobile(){return window.innerWidth<=800}setupCanvas(){this.canvas||(this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d",{alpha:!1}),this.canvas.className="toolbar-canvas"),this.canvas.parentNode||document.body.appendChild(this.canvas),this.canvas.width=this.isMobile?window.innerWidth:50,this.canvas.height=this.isMobile?50:window.innerHeight}ensureTooltip(){if(this.tooltip)return;const t=document.createElement("div");t.className="toolbar-tooltip",t.style.display="none",document.body.appendChild(t),this.tooltip=t}showTooltip(t,i,e){this.isMobile||(this.ensureTooltip(),this.tooltip&&(this.tooltip.textContent=t,this.tooltip.style.left=`${i+12}px`,this.tooltip.style.top=`${e+12}px`,this.tooltip.style.display="block"))}hideTooltip(){this.tooltip&&(this.tooltip.style.display="none")}createButtons(){const t=["/MazeSolver3D/icon/maze.png","/MazeSolver3D/icon/generate_maze.png","/MazeSolver3D/icon/solving_maze.png","/MazeSolver3D/icon/question.png","/MazeSolver3D/icon/setting.png"];return[{name:"Custom Maze",icon:t[0],action:()=>this.togglePopup("maze"),x:0,y:0,width:0,height:0},{name:"Generate Maze",icon:t[1],action:()=>this.togglePopup("generate"),x:0,y:0,width:0,height:0},{name:"Solving Maze",icon:t[2],action:()=>this.togglePopup("solve"),x:0,y:0,width:0,height:0},{name:"Tutorial",icon:t[3],action:()=>this.togglePopup("tutorial"),x:0,y:0,width:0,height:0},{name:"Settings",icon:t[4],action:()=>this.togglePopup("settings"),x:0,y:0,width:0,height:0}]}async preloadImages(){const t=this.buttons.map(i=>new Promise((e,s)=>{if(this.imageCache.has(i.icon)){i.image=this.imageCache.get(i.icon),e();return}const n=new Image;n.onload=()=>{this.imageCache.set(i.icon,n),i.image=n,e()},n.onerror=()=>{console.error(`Failed to load icon: ${i.icon}`),s(new Error(`Failed to load ${i.icon}`))},n.src=i.icon}));try{await Promise.all(t)}catch(i){console.error("Error loading toolbar icons:",i)}}drawToolbar(){this.imagesLoaded&&(this.ctx.fillStyle="#333",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.isMobile?this.drawToolbarVertical():this.drawToolbarHorizontal())}drawToolbarVertical(){const s=this.buttons.length*60;let n=(this.canvas.width-s)/2;this.buttons.forEach(r=>{r.image&&(this.ctx.drawImage(r.image,n-2,8,36,36),this.ctx.strokeStyle="#fff",this.ctx.lineWidth=1,this.ctx.strokeRect(n-5,5,40,40),r.x=n-5,r.y=5,r.width=40,r.height=40),n+=60})}drawToolbarHorizontal(){const s=this.buttons.length*60;let n=(this.canvas.height-s)/2;this.buttons.forEach(r=>{r.image&&(this.ctx.drawImage(r.image,8,n-2,36,36),this.ctx.strokeStyle="#fff",this.ctx.lineWidth=1,this.ctx.strokeRect(5,n-5,40,40),r.x=5,r.y=n-5,r.width=40,r.height=40),n+=60})}addEventListeners(){this.removeEventListeners(),this.mouseMoveHandler=t=>{let i="default",e=null;for(const s of this.buttons)if(this.isInside(t.clientX,t.clientY,s)){i="pointer",e=s;break}this.canvas.style.cursor=i,e?(this.hoveredButton!==e&&(this.hoveredButton=e),this.showTooltip(e.name,t.clientX,t.clientY)):(this.hoveredButton=null,this.hideTooltip())},this.canvas.addEventListener("mousemove",this.mouseMoveHandler,{passive:!0}),this.mouseLeaveHandler=()=>{this.hoveredButton=null,this.hideTooltip()},this.canvas.addEventListener("mouseleave",this.mouseLeaveHandler,{passive:!0}),this.mouseDownHandler=t=>this.handleCanvasClick(t),this.touchStartHandler=t=>this.handleCanvasClick(t),this.canvas.addEventListener("mousedown",this.mouseDownHandler),this.canvas.addEventListener("touchstart",this.touchStartHandler,{passive:!0}),this.documentClickHandler=t=>this.handleDocumentClick(t),document.addEventListener("click",this.documentClickHandler,{passive:!0}),document.addEventListener("touchstart",this.documentClickHandler,{passive:!0})}removeEventListeners(){this.mouseMoveHandler&&this.canvas.removeEventListener("mousemove",this.mouseMoveHandler),this.mouseLeaveHandler&&this.canvas.removeEventListener("mouseleave",this.mouseLeaveHandler),this.mouseDownHandler&&this.canvas.removeEventListener("mousedown",this.mouseDownHandler),this.touchStartHandler&&this.canvas.removeEventListener("touchstart",this.touchStartHandler),this.documentClickHandler&&(document.removeEventListener("click",this.documentClickHandler),document.removeEventListener("touchstart",this.documentClickHandler))}handleCanvasClick(t){const i="clientX"in t?t.clientX:t.touches[0].clientX,e="clientY"in t?t.clientY:t.touches[0].clientY;for(const s of this.buttons)if(this.isInside(i,e,s)){s.action();break}}handleDocumentClick(t){if(!this.popupOpen)return;const i=t.target;this.canvas.contains(i)||this.currentCloseIcon&&this.currentCloseIcon.contains(i)||this.currentHideIcon&&this.currentHideIcon.contains(i)||this.currentPopup&&this.currentPopup.contains(i)||this.hideCurrentPopup()}resizeToolbar(){const t=this.isMobile;this.isMobile=this.checkIfMobile(),t!==this.isMobile?(this.removeEventListeners(),this.removeCanvas(),this.setupCanvas(),this.addEventListeners()):(this.canvas.width=this.isMobile?window.innerWidth:50,this.canvas.height=this.isMobile?50:window.innerHeight),this.drawToolbar()}removeCanvas(){this.canvas&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas)}isInside(t,i,e){return t>=e.x&&t<=e.x+e.width&&i>=e.y&&i<=e.y+e.height}togglePopup(t){const i=`${t}Popup`;if(this.currentPopup&&this.currentPopup.id===i&&this.isPopupVisible(this.currentPopup)){this.hideCurrentPopup();return}this.currentPopup&&this.currentPopup.id!==i&&this.isPopupVisible(this.currentPopup)&&this.hideCurrentPopup(),this.showPopup(t)}showPopup(t){const i=`${t}Popup`,e=document.getElementById(i);if(e){e.style.display="block",this.popupOpen=!0,this.currentPopup=e,this.addCloseIcon(),this.addHideIcon();return}switch(this.popupOpen=!0,t){case"solve":Tt(this);break;case"generate":Ht(this);break;case"tutorial":Ot(this);break;case"settings":It(this);break;case"maze":Dt(this);break}}createPopupContainer(t,i){const e=document.createElement("div");e.id=t,e.className="toolbar-popup",e.style.setProperty("--toolbar-popup-top",this.isMobile?"50px":"0"),e.style.setProperty("--toolbar-popup-left",this.isMobile?"50%":"238px"),document.body.appendChild(e);const s=document.createElement("canvas");s.width=370,s.height=4e3,e.appendChild(s);const n=document.createElement("h3");return n.className="toolbar-popup__title",n.textContent=i,e.appendChild(n),this.addCloseIcon(),this.addHideIcon(),this.currentPopup=e,e}addCloseIcon(){this.currentCloseIcon&&document.body.removeChild(this.currentCloseIcon);const t=new Image;t.src="/MazeSolver3D/icon/close.png",t.className="toolbar-popup__close",t.title="Close",t.style.setProperty("--toolbar-close-top",this.isMobile?"56px":"10px"),t.style.setProperty("--toolbar-close-left",this.isMobile?"calc(50% + 160px)":"400px"),t.addEventListener("click",()=>this.closeCurrentPopup()),document.body.appendChild(t),this.currentCloseIcon=t}addHideIcon(){this.currentHideIcon&&document.body.removeChild(this.currentHideIcon);const t=new Image;t.src="/MazeSolver3D/icon/hide.png",t.className="toolbar-popup__hide",t.title="Hide",t.style.setProperty("--toolbar-hide-top",this.isMobile?"56px":"10px"),t.style.setProperty("--toolbar-hide-left",this.isMobile?"calc(50% + 120px)":"360px"),t.addEventListener("click",()=>this.hideCurrentPopup()),document.body.appendChild(t),this.currentHideIcon=t}closePopup(t){const i=document.getElementById(`${t}Popup`);i&&i.parentNode&&i.parentNode.removeChild(i),this.currentCloseIcon&&this.currentCloseIcon.parentNode&&(this.currentCloseIcon.parentNode.removeChild(this.currentCloseIcon),this.currentCloseIcon=null),this.currentHideIcon&&this.currentHideIcon.parentNode&&(this.currentHideIcon.parentNode.removeChild(this.currentHideIcon),this.currentHideIcon=null),document.querySelectorAll(".popup-input").forEach(s=>{var n;return(n=s.parentElement)==null?void 0:n.removeChild(s)}),this.popupOpen=!1,this.currentPopup=null}closeCurrentPopup(){this.currentPopup&&this.currentPopup.parentNode&&(this.currentPopup.parentNode.removeChild(this.currentPopup),this.currentPopup=null),this.currentCloseIcon&&this.currentCloseIcon.parentNode&&(this.currentCloseIcon.parentNode.removeChild(this.currentCloseIcon),this.currentCloseIcon=null),this.currentHideIcon&&this.currentHideIcon.parentNode&&(this.currentHideIcon.parentNode.removeChild(this.currentHideIcon),this.currentHideIcon=null),this.popupOpen=!1}hideCurrentPopup(){this.currentPopup&&(this.currentPopup.style.display="none"),this.currentCloseIcon&&this.currentCloseIcon.parentNode&&(this.currentCloseIcon.parentNode.removeChild(this.currentCloseIcon),this.currentCloseIcon=null),this.currentHideIcon&&this.currentHideIcon.parentNode&&(this.currentHideIcon.parentNode.removeChild(this.currentHideIcon),this.currentHideIcon=null),this.popupOpen=!1}isPopupVisible(t){return t.style.display!=="none"}destroy(){this.removeEventListeners(),this.removeCanvas(),this.closeCurrentPopup(),this.tooltip&&this.tooltip.parentNode&&(this.tooltip.parentNode.removeChild(this.tooltip),this.tooltip=null),this.imageCache.clear(),this.buttons=[]}}class Bt{constructor(t,i={}){a(this,"gui");a(this,"settings");a(this,"mazeController");a(this,"mobileBreakpoint");a(this,"guiScale");a(this,"autoHide");a(this,"controllers",new Map);this.mazeController=t,this.mobileBreakpoint=i.mobileBreakpoint??800,this.guiScale=i.scale??1.4,this.autoHide=i.autoHide??!0,this.settings={backgroundColor:"#999999",wallColor:"#808080",floorColor:"#C0C0C0",wallOpacity:1,floorOpacity:1,showEdges:!0,showDebug:!0,showPreview:!0},this.gui=new Et,this.initializeGUI(),this.autoHide&&this.setupResponsiveness()}initializeGUI(){this.styleGUIContainer(),this.addColorControls(),this.addOpacityControls(),this.addEdgeControl(),this.addDebugControl(),this.addPreviewControl()}styleGUIContainer(){const t=this.gui.domElement.parentElement;t&&(t.classList.add("scaled-gui"),Object.assign(t.style,{zIndex:"1000",right:"-20px",transformOrigin:"top right",transform:`scale(${this.guiScale})`}))}addColorControls(){const t=this.gui.addColor(this.settings,"backgroundColor");t.onChange(s=>{const n=this.mazeController.getRenderer();n&&(n.setClearColor(s),this.mazeController.requestRender())}),this.controllers.set("backgroundColor",t);const i=this.gui.addColor(this.settings,"wallColor");i.onChange(s=>{this.mazeController.updateWallColor(s)}),this.controllers.set("wallColor",i);const e=this.gui.addColor(this.settings,"floorColor");e.onChange(s=>{this.mazeController.updateFloorColor(s)}),this.controllers.set("floorColor",e)}addOpacityControls(){const t=this.gui.add(this.settings,"wallOpacity",0,1,.01);t.onChange(e=>{this.mazeController.updateWallOpacity(e)}),this.controllers.set("wallOpacity",t);const i=this.gui.add(this.settings,"floorOpacity",0,1,.01);i.onChange(e=>{this.mazeController.updateFloorOpacity(e)}),this.controllers.set("floorOpacity",i)}addEdgeControl(){const t=this.gui.add(this.settings,"showEdges");t.onChange(i=>{this.mazeController.toggleEdges(i)}),this.controllers.set("showEdges",t)}addDebugControl(){const t=this.gui.add(this.settings,"showDebug");t.onChange(i=>{this.mazeController.setDebugOverlayVisible(i)}),this.controllers.set("showDebug",t)}addPreviewControl(){const t=this.gui.add(this.settings,"showPreview");t.onChange(i=>{this.mazeController.setPreviewVisible(i)}),this.controllers.set("showPreview",t)}setupResponsiveness(){this.updateGUIVisibility(),window.addEventListener("resize",()=>this.updateGUIVisibility())}updateGUIVisibility(){if(!this.gui.domElement)return;const t=window.innerWidth>this.mobileBreakpoint;this.gui.domElement.style.display=t?"block":"none"}checkWindowSize(){this.autoHide&&this.updateGUIVisibility()}updateSetting(t,i){this.settings[t]=i;const e=this.controllers.get(t);e&&e.updateDisplay&&e.updateDisplay()}setControllerEnabled(t,i,e){const s=this.controllers.get(t);if(!s||!s.domElement)return;const n=s.domElement,r=n.querySelector("input, select, button");r&&(r.disabled=!i),e?n.setAttribute("title",e):n.removeAttribute("title"),n.classList.toggle("is-disabled",!i)}setVisible(t){this.gui.domElement&&(this.gui.domElement.style.display=t?"block":"none")}destroy(){if(this.controllers.clear(),this.gui&&this.gui.domElement){const t=this.gui.domElement.parentElement;t&&t.parentElement&&t.parentElement.removeChild(t)}}}const m={background:"#2a2a2a",surface:"#3a3a3a",surfaceTop:"#4a4a4a",wall:"#808080",path:"#c0c0c0",grid:"#1a1a1a",border:"#1a1a1a",borderSoft:"#2a2a2a",footerBorder:"#1f1f1f",legendBg:"#333",buttonBg:"#2f2f2f",buttonBorder:"#1a1a1a",buttonHover:"#3a3a3a",buttonActive:"#2a2a2a",buttonActiveBorder:"#2e5a2e",closeActive:"#a33",resizeGrip:"#5a5a5a",markerStart:"#2ecc71",markerEnd:"#e74c3c",markerBoth:"#f1c40f",markerStroke:"#111",markerText:"#f6f6f6"};function ce(d){if(!d||d.length===0||!Array.isArray(d[0]))return null;const t=d.length,i=d[0].length,e=[],s=[];for(let l=0;l<t;l+=1)for(let c=0;c<i;c+=1){if(d[l][c]!==0)continue;const f={row:l,col:c};s.push(f),(l===0||l===t-1||c===0||c===i-1)&&e.push(f)}let n=e[0]??null,r=e.length>1?e[e.length-1]:null;return n||(n=s[0]??null),r||(r=s.length>1?s[s.length-1]:n),{start:n,end:r}}class At{constructor(t={}){a(this,"container");a(this,"titleBar");a(this,"canvas");a(this,"ctx");a(this,"closeButton");a(this,"hideButton");a(this,"gridToggleButton");a(this,"footer");a(this,"legend");a(this,"startCell",null);a(this,"endCell",null);a(this,"showGrid",!1);a(this,"isClosed",!1);a(this,"onHide");a(this,"onClose");a(this,"isDragging",!1);a(this,"dragStartX",0);a(this,"dragStartY",0);a(this,"windowX",0);a(this,"windowY",0);a(this,"width");a(this,"height");a(this,"canvasWidth",256);a(this,"canvasHeight",256);a(this,"isVisible",!0);a(this,"isHiding",!1);a(this,"hideTimeoutId",null);a(this,"hideTransitionMs",350);a(this,"mazeData",null);a(this,"layout",null);a(this,"onMouseMoveHandler");a(this,"onMouseUpHandler");a(this,"onMouseDownHandler");this.onHide=t.onHide,this.onClose=t.onClose,this.width=t.width??300,this.height=t.height??320;const i=20,e=Math.max(i,window.innerWidth-this.width-i),s=Math.max(i,window.innerHeight-this.height-i);this.windowX=t.initialX??e,this.windowY=t.initialY??s,this.container=document.createElement("div"),this.container.className="preview-window",this.container.style.width=`${this.width}px`,this.container.style.height=`${this.height}px`,this.container.style.left=`${this.windowX}px`,this.container.style.top=`${this.windowY}px`,this.container.style.setProperty("--preview-bg",m.background),this.container.style.setProperty("--preview-surface",m.surface),this.container.style.setProperty("--preview-surface-top",m.surfaceTop),this.container.style.setProperty("--preview-wall",m.wall),this.container.style.setProperty("--preview-path",m.path),this.container.style.setProperty("--preview-grid",m.grid),this.container.style.setProperty("--preview-border",m.border),this.container.style.setProperty("--preview-border-soft",m.borderSoft),this.container.style.setProperty("--preview-footer-border",m.footerBorder),this.container.style.setProperty("--preview-legend-bg",m.legendBg),this.container.style.setProperty("--preview-button-bg",m.buttonBg),this.container.style.setProperty("--preview-button-border",m.buttonBorder),this.container.style.setProperty("--preview-button-hover",m.buttonHover),this.container.style.setProperty("--preview-button-active",m.buttonActive),this.container.style.setProperty("--preview-button-active-border",m.buttonActiveBorder),this.container.style.setProperty("--preview-close-active",m.closeActive),this.container.style.setProperty("--preview-resize-grip",m.resizeGrip),this.container.style.setProperty("--preview-start",m.markerStart),this.container.style.setProperty("--preview-end",m.markerEnd),this.container.style.setProperty("--preview-marker-both",m.markerBoth),this.container.style.setProperty("--preview-marker-stroke",m.markerStroke),this.container.style.setProperty("--preview-marker-text",m.markerText),this.container.style.setProperty("--preview-hide-duration",`${this.hideTransitionMs}ms`),this.titleBar=document.createElement("div"),this.titleBar.className="preview-titlebar",this.titleBar.textContent=t.title??"Preview",this.closeButton=document.createElement("button"),this.closeButton.className="preview-close-btn",this.closeButton.textContent="x",this.hideButton=document.createElement("button"),this.hideButton.className="preview-hide-btn",this.hideButton.type="button",this.hideButton.setAttribute("title","Hide preview"),this.hideButton.textContent="-",this.gridToggleButton=document.createElement("button"),this.gridToggleButton.className="preview-grid-btn",this.gridToggleButton.type="button",this.gridToggleButton.setAttribute("aria-pressed",String(this.showGrid)),this.gridToggleButton.setAttribute("title","Toggle grid"),this.gridToggleButton.textContent="Grid",this.gridToggleButton.classList.toggle("active",this.showGrid),this.legend=document.createElement("div"),this.legend.className="preview-legend",this.legend.innerHTML='<span class="preview-legend-item"><i class="preview-swatch wall"></i>Wall</span><span class="preview-legend-item"><i class="preview-swatch path"></i>Path</span><span class="preview-legend-item"><i class="preview-swatch start"></i>Start</span><span class="preview-legend-item"><i class="preview-swatch end"></i>End</span>',this.footer=document.createElement("div"),this.footer.className="preview-footer",this.footer.appendChild(this.gridToggleButton),this.canvas=document.createElement("canvas"),this.canvas.className="preview-canvas",this.canvas.width=this.canvasWidth,this.canvas.height=this.canvasHeight;const n=this.canvas.getContext("2d");if(!n)throw new Error("Could not get 2D context");this.ctx=n,this.ctx.imageSmoothingEnabled=!1;const r=document.createElement("div");r.className="preview-title-actions",r.appendChild(this.hideButton),r.appendChild(this.closeButton),this.titleBar.appendChild(r),this.container.appendChild(this.titleBar),this.container.appendChild(this.legend),this.container.appendChild(this.canvas),this.container.appendChild(this.footer),document.body.appendChild(this.container),this.onMouseMoveHandler=l=>this.onMouseMove(l),this.onMouseUpHandler=()=>this.onMouseUp(),this.onMouseDownHandler=l=>this.onMouseDown(l),this.setupEventListeners(),this.render()}setupEventListeners(){this.closeButton.addEventListener("click",t=>{t.stopPropagation(),this.close()}),this.hideButton.addEventListener("click",t=>{t.stopPropagation(),this.hide()}),this.gridToggleButton.addEventListener("click",t=>{t.stopPropagation(),this.showGrid=!this.showGrid,this.gridToggleButton.setAttribute("aria-pressed",String(this.showGrid)),this.gridToggleButton.classList.toggle("active",this.showGrid),this.render()}),this.titleBar.addEventListener("mousedown",this.onMouseDownHandler),document.addEventListener("mousemove",this.onMouseMoveHandler),document.addEventListener("mouseup",this.onMouseUpHandler),this.titleBar.addEventListener("selectstart",t=>t.preventDefault())}onMouseDown(t){t.target!==this.closeButton&&(this.isDragging=!0,this.dragStartX=t.clientX-this.windowX,this.dragStartY=t.clientY-this.windowY,this.container.classList.add("dragging"))}onMouseMove(t){this.isDragging&&(this.windowX=t.clientX-this.dragStartX,this.windowY=t.clientY-this.dragStartY,this.windowX=Math.max(0,Math.min(this.windowX,window.innerWidth-this.width)),this.windowY=Math.max(0,Math.min(this.windowY,window.innerHeight-this.height)),this.container.style.left=`${this.windowX}px`,this.container.style.top=`${this.windowY}px`)}onMouseUp(){this.isDragging=!1,this.container.classList.remove("dragging")}updateMaze(t,i){if(this.mazeData=t,i)this.startCell=i.start??null,this.endCell=i.end??null;else{const e=ce(t),s=(e==null?void 0:e.start)??null,n=(e==null?void 0:e.end)??null;this.startCell=s,this.endCell=n}this.layout=this.computeLayout(t),this.render()}render(){if(this.ctx.fillStyle=m.background,this.ctx.fillRect(0,0,this.canvasWidth,this.canvasHeight),!this.mazeData||this.mazeData.length===0||(this.layout||(this.layout=this.computeLayout(this.mazeData)),!this.layout))return;const{rows:t,cols:i,cellSize:e,offsetX:s,offsetY:n}=this.layout,r=this.mazeData,l=this.showGrid?0:.5;let c=null;this.showGrid&&(this.ctx.strokeStyle=m.grid,this.ctx.lineWidth=1);for(let g=0;g<t;g++){const p=r[g];for(let y=0;y<i;y++){const M=s+y*e,b=n+(t-1-g)*e,C=p[y]===1?m.wall:m.path;c!==C&&(c=C,this.ctx.fillStyle=c),this.ctx.fillRect(M-l,b-l,e+l*2,e+l*2),this.showGrid&&this.ctx.strokeRect(M,b,e,e)}}this.startCell&&this.endCell&&this.startCell.row===this.endCell.row&&this.startCell.col===this.endCell.col&&this.startCell?this.drawMarker(this.startCell,t,e,s,n,m.markerBoth):(this.startCell&&this.drawMarker(this.startCell,t,e,s,n,m.markerStart),this.endCell&&this.drawMarker(this.endCell,t,e,s,n,m.markerEnd))}computeLayout(t){const i=t.length;if(i===0)return null;const e=t[0].length,s=this.canvasWidth/e,n=this.canvasHeight/i,r=Math.min(s,n),l=(this.canvasWidth-r*e)/2,c=(this.canvasHeight-r*i)/2;return{rows:i,cols:e,cellSize:r,offsetX:l,offsetY:c}}drawMarker(t,i,e,s,n,r){const l=s+t.col*e,c=n+(i-1-t.row)*e;this.ctx.fillStyle=r,this.ctx.fillRect(l,c,e,e)}show(){this.isClosed||(this.isVisible=!0,this.isHiding=!1,this.hideTimeoutId!==null&&(window.clearTimeout(this.hideTimeoutId),this.hideTimeoutId=null),this.container.classList.remove("is-hiding"),this.container.style.display="block")}hide(){if(this.isClosed||this.isHiding||!this.isVisible)return;this.isVisible=!1,this.isHiding=!0,this.onHide&&this.onHide();const t=()=>{!this.isHiding||this.isClosed||(this.isHiding=!1,this.container.style.display="none",this.container.classList.remove("is-hiding"),this.hideTimeoutId!==null&&(window.clearTimeout(this.hideTimeoutId),this.hideTimeoutId=null))};this.container.classList.add("is-hiding"),this.hideTimeoutId=window.setTimeout(t,this.hideTransitionMs+40)}toggle(){this.isVisible?this.hide():this.show()}isWindowVisible(){return this.isVisible}handleWindowResize(){const t=Math.max(0,window.innerWidth-this.width),i=Math.max(0,window.innerHeight-this.height);this.windowX=Math.max(0,Math.min(this.windowX,t)),this.windowY=Math.max(0,Math.min(this.windowY,i)),this.container.style.left=`${this.windowX}px`,this.container.style.top=`${this.windowY}px`}close(){this.isClosed||(this.isClosed=!0,this.isVisible=!1,this.isHiding=!1,this.hideTimeoutId!==null&&(window.clearTimeout(this.hideTimeoutId),this.hideTimeoutId=null),this.onClose&&this.onClose(),this.destroy())}destroy(){this.titleBar.removeEventListener("mousedown",this.onMouseDownHandler),document.removeEventListener("mousemove",this.onMouseMoveHandler),document.removeEventListener("mouseup",this.onMouseUpHandler),this.hideTimeoutId!==null&&(window.clearTimeout(this.hideTimeoutId),this.hideTimeoutId=null),this.container.remove()}}class Nt{constructor(){a(this,"canvas");a(this,"toolbar");a(this,"maze");a(this,"guiController");a(this,"previewWindow");a(this,"resizeHandler");a(this,"debugOverlay",null);a(this,"debugRafId",null);a(this,"debugLastUpdate",0);a(this,"debugLastRenderCount",0);a(this,"debugUpdateIntervalMs",250);a(this,"renderCount",0);a(this,"renderListener");a(this,"previewMarkers",null);a(this,"isDebugOverlayVisible",!0);a(this,"isPreviewVisible",!0);a(this,"isPreviewClosed",!1);a(this,"mobileBreakpoint",800);if(this.canvas=document.getElementById("mazeCanvas"),!this.canvas)throw new Error('Canvas element "mazeCanvas" not found');this.toolbar=new Rt,this.maze=this.createInitialMaze();const t=this.maze.getMazeData();this.previewMarkers=ce(t==null?void 0:t[0]),this.guiController=new Bt(this,{scale:1.4,mobileBreakpoint:this.mobileBreakpoint,autoHide:!0});const i=window.innerWidth<=this.mobileBreakpoint;this.isDebugOverlayVisible=!i,this.isPreviewVisible=!i,this.guiController.updateSetting("showDebug",this.isDebugOverlayVisible),this.guiController.updateSetting("showPreview",this.isPreviewVisible),this.previewWindow=new At({title:"Preview",width:300,height:320,onHide:()=>this.handlePreviewHidden(),onClose:()=>this.handlePreviewClosed()}),this.renderListener=()=>{this.renderCount+=1},this.maze.addRenderListener(this.renderListener),this.setupDebugOverlay(),this.setDebugOverlayVisible(this.isDebugOverlayVisible),this.setPreviewVisible(this.isPreviewVisible),this.getRenderer().setClearColor(this.guiController.settings.backgroundColor),this.updatePreview(),this.resizeHandler=()=>this.onWindowResize(),window.addEventListener("resize",this.resizeHandler),window.addEventListener("keydown",e=>{(e.key==="p"||e.key==="P")&&this.setPreviewVisible(!this.isPreviewVisible)})}createInitialMaze(){const t=[[[1,1,1,1,1,1,1,1,1,1,0,1],[1,0,0,0,0,0,1,0,0,0,0,1],[1,0,1,1,1,0,1,0,1,1,0,1],[1,0,1,0,0,0,0,0,1,0,0,1],[1,0,1,0,1,1,1,1,1,1,0,1],[1,0,0,0,1,0,0,0,0,0,0,1],[1,1,1,0,1,0,1,1,1,1,1,1],[1,0,0,0,1,0,1,0,0,0,0,1],[1,0,1,1,1,0,1,0,1,1,0,1],[1,0,0,0,0,0,1,0,1,0,0,1],[1,0,1,1,1,1,1,0,1,1,0,1],[0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1]]];return new le(this.canvas,t)}onWindowResize(){var n;this.toolbar.resizeToolbar(),this.maze.resize(),this.guiController.checkWindowSize(),(n=this.previewWindow)==null||n.handleWindowResize();const t=window.innerWidth<=this.mobileBreakpoint,i=!t,s=!t&&!this.isPreviewClosed;this.isDebugOverlayVisible!==i&&(this.setDebugOverlayVisible(i),this.guiController.updateSetting("showDebug",i)),this.isPreviewVisible!==s&&(this.setPreviewVisible(s),this.guiController.updateSetting("showPreview",s))}updateMaze(t,i=!1,e){const s=!i&&this.maze instanceof le,n=i&&this.maze instanceof Ne;if(s||n?this.maze.updateMazeData(t):(this.maze.removeRenderListener(this.renderListener),this.maze.destroy(),i?this.maze=new Ne(this.canvas,t):this.maze=new le(this.canvas,t),this.applyGUISettings(),this.maze.addRenderListener(this.renderListener)),e)this.previewMarkers={start:e.start??null,end:e.end??null};else{const r=this.maze.getMazeData();this.previewMarkers=ce(r==null?void 0:r[0])}this.updatePreview()}updatePreview(){var i,e;const t=this.maze.maze;t&&t.length>0&&(this.previewMarkers?(i=this.previewWindow)==null||i.updateMaze(t[0],this.previewMarkers):(e=this.previewWindow)==null||e.updateMaze(t[0]))}applyGUISettings(){const t=this.getRenderer();t&&(t.setClearColor(this.guiController.settings.backgroundColor),this.requestRender())}createMultiLayerMaze(){const t=[[[1,0,1,1,1,1],[1,0,0,1,0,1],[1,1,0,0,0,1],[1,0,0,0,0,1],[1,1,1,1,1,1]],[[1,0,1,1,1,1],[1,0,0,1,0,1],[1,0,0,1,1,1],[1,0,0,0,0,1],[1,1,1,1,1,1]]];this.updateMaze(t,!0)}createSingleLayerMaze(){const t=[[[1,1,1,1,1],[1,0,0,0,1],[1,0,1,0,1],[1,0,0,0,1],[1,1,1,1,1]]];this.updateMaze(t,!1)}togglePreview(){this.setPreviewVisible(!this.isPreviewVisible)}getRenderer(){return this.maze.getRenderer()}getMazeData(){return this.maze.getMazeData()}getMazeMarkers(){return this.previewMarkers?{...this.previewMarkers}:null}updateWallColor(t){this.maze.updateWallColor(t)}updateFloorColor(t){this.maze.updateFloorColor(t)}updateWallOpacity(t){this.maze.updateWallOpacity(t)}updateFloorOpacity(t){this.maze.updateFloorOpacity(t)}toggleEdges(t){this.maze.toggleEdges(t)}requestRender(){this.maze.requestRender()}destroy(){var t;window.removeEventListener("resize",this.resizeHandler),this.maze.destroy(),this.guiController.destroy(),(t=this.previewWindow)==null||t.destroy(),this.stopDebugLoop(),this.debugOverlay&&this.debugOverlay.parentNode&&this.debugOverlay.parentNode.removeChild(this.debugOverlay)}setDebugOverlayVisible(t){this.isDebugOverlayVisible=t,this.debugOverlay&&(this.debugOverlay.style.display=t?"block":"none"),t?this.startDebugLoop():this.stopDebugLoop()}setPreviewVisible(t){if(this.isPreviewVisible=t,this.isPreviewClosed||!this.previewWindow){t&&(this.isPreviewVisible=!1,this.guiController.updateSetting("showPreview",!1));return}t?this.previewWindow.show():this.previewWindow.hide()}handlePreviewHidden(){this.isPreviewVisible=!1,this.guiController.updateSetting("showPreview",!1)}handlePreviewClosed(){this.isPreviewVisible=!1,this.isPreviewClosed=!0,this.previewWindow=null,this.guiController.updateSetting("showPreview",!1),this.guiController.setControllerEnabled("showPreview",!1,"Preview closed. Open a new preview window from Settings.")}setupDebugOverlay(){this.renderCount=0;const t=document.createElement("div");t.id="debug-overlay",Object.assign(t.style,{position:"fixed",top:"8px",left:"58px",padding:"6px 8px",background:"rgba(0, 0, 0, 0.6)",color:"#e6e6e6",fontFamily:"monospace",fontSize:"12px",borderRadius:"4px",zIndex:"1000",pointerEvents:"none",whiteSpace:"pre"}),document.body.appendChild(t),this.debugOverlay=t,this.startDebugLoop()}startDebugLoop(){if(this.debugRafId!==null)return;this.debugLastUpdate=performance.now(),this.debugLastRenderCount=this.renderCount;const t=i=>{if(!this.debugOverlay){this.debugRafId=null;return}if(i-this.debugLastUpdate>=this.debugUpdateIntervalMs){const e=(i-this.debugLastUpdate)/1e3,s=this.renderCount-this.debugLastRenderCount,n=e>0?s/e:0,r=s>0&&e>0?e*1e3/s:0;this.debugOverlay.textContent=`FPS: ${n.toFixed(1)}
Frame: ${r.toFixed(2)} ms`,this.debugLastUpdate=i,this.debugLastRenderCount=this.renderCount}this.debugRafId=window.requestAnimationFrame(t)};this.debugRafId=window.requestAnimationFrame(t)}stopDebugLoop(){this.debugRafId!==null&&(window.cancelAnimationFrame(this.debugRafId),this.debugRafId=null)}}let V=null;window.onload=()=>{try{V=new Nt,window.mazeApp=V}catch(d){console.error("Failed to initialize application:",d)}};window.onbeforeunload=()=>{V&&(V.destroy(),V=null)};
